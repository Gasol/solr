#!/usr/bin/make -f
# -*- makefile -*-
#
include /usr/share/cdbs/1/rules/debhelper.mk
include /usr/share/cdbs/1/rules/dpatch.mk
include /usr/share/cdbs/1/class/ant.mk

# Uncomment this to turn on verbose mode.
# export DH_VERBOSE=1

# Upstream version information
UPSTREAM_VERSION := $(shell echo $(DEB_VERSION) | grep -o "^[[:digit:]\.]*")
UPSTREAM_BASENAME = apache-solr-$(UPSTREAM_VERSION)

COMMON_INSTDIR=$(CURDIR)/debian/solr-common
TOMCAT_INSTDIR=$(CURDIR)/debian/solr-tomcat5.5
JETTY_INSTDIR=$(CURDIR)/debian/solr-jetty
SHAREDIR=$(COMMON_INSTDIR)/usr/share/solr

WARFILE = $(UPSTREAM_BASENAME).war

# Explicitly build with sun-java5-jdk
JAVA_HOME = /usr/lib/jvm/java-1.5.0-sun
JAR = $(JAVA_HOME)/bin/jar

DEB_ANT_BUILD_TARGET = compile dist-war
#DEB_ANT_CHECK_TARGET = test
DEB_JARS = ant-junit junit

clean::
	rm -rf example/solr/data/index
	rm -f debian/solr-keyring.gpg

install/solr-common::
	# First unpack the .war file, we need most of it.
	cd $(SHAREDIR) ; $(JAR) xf $(CURDIR)/dist/$(WARFILE) 
	mv $(SHAREDIR)/WEB-INF/web.xml $(COMMON_INSTDIR)/etc/solr/
	
	# Install replication scripts
	install src/scripts/* $(SHAREDIR)/bin
	
	install -d $(COMMON_INSTDIR)/usr/share/doc/solr-common/
	install CHANGES.txt $(COMMON_INSTDIR)/usr/share/doc/solr-common/changelog
	
	# Install Solr configuration files
	# FIXME: this is example configuration, including example schema
	# Should be changed to some minimal config, with pointers
	# to documentation
	cp -r $(CURDIR)/example/solr/conf/* $(COMMON_INSTDIR)/etc/solr/conf/
	
	# This information is already in debian/copyright
	rm -f $(COMMON_INSTDIR)/usr/share/solr/META-INF/LICENSE.txt
	
install/solr-tomcat5.5::
	# Configure tomcat (also see solr-tomcat5.5.links)
	install --mode 0644 debian/solr-tomcat5.5.xml $(TOMCAT_INSTDIR)/etc/solr/
	install --mode 0644 debian/tomcat.policy $(TOMCAT_INSTDIR)/etc/solr/tomcat.policy

install/solr-jetty::
	# Configure Jetty
	install --mode 0644 debian/jetty-web.xml $(JETTY_INSTDIR)/usr/share/solr/WEB-INF/

remove-source:
	rm -f build.xml
	rm -f *.txt
	rm -f *stamp
	rm -rf debian/patched
	rm -rf build dist docs example lib src
	rm -rf apache-solr*

restore-from-source: remove-source
	tar xzf ../solr_$(UPSTREAM_VERSION).orig.tar.gz
	mv $(UPSTREAM_BASENAME)/* .
	rmdir $(UPSTREAM_BASENAME)

get-orig-source:
	debian/get-orig-source

check:
	lintian -i ../solr_$(DEB_VERSION)_$(DEB_BUILD_ARCH).changes
	linda -i ../solr_$(DEB_VERSION)_$(DEB_BUILD_ARCH).changes
	zgrep "^---" ../solr_$(DEB_VERSION).diff.gz | grep -v debian || true
	dpkg --contents ../solr-common_$(DEB_VERSION)_all.deb
	dpkg --contents ../solr-tomcat5.5_$(DEB_VERSION)_all.deb
	dpkg --contents ../solr-jetty_$(DEB_VERSION)_all.deb

upload:
	cd .. ; dupload -t vanbest solr_$(DEB_VERSION)_$(DEB_BUILD_ARCH).changes 
	#cd .. ; dupload -t mentors solr_$(DEB_VERSION)_$(DEB_BUILD_ARCH).changes
